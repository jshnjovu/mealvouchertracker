name: Deploy to VM

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Backend Tests
        run: |
          cd backend
          pytest

      - name: Package Application
        run: |
          zip -r project.zip . -x "frontend/node_modules/*" "backend/.venv/*" "*/__pycache__/*" ".git/*" ".claude/*" "frontend/dist/*" "backend/.pytest_cache/*"

      - name: Copy Files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "project.zip"
          target: "~/"

      - name: Deploy on VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          ADMIN_PIN: ${{ secrets.ADMIN_PIN }}
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: VITE_API_URL,SMTP_USER,SMTP_PASSWORD,SMTP_HOST,SMTP_PORT,ADMIN_PIN
          script: |
            # Create .env file with secrets
            echo "ADMIN_PIN=$ADMIN_PIN" > .env
            echo "SMTP_USER=$SMTP_USER" >> .env
            echo "SMTP_PASSWORD=$SMTP_PASSWORD" >> .env
            echo "SMTP_HOST=$SMTP_HOST" >> .env
            echo "SMTP_PORT=$SMTP_PORT" >> .env
            echo "VITE_API_URL=$VITE_API_URL" >> .env

            # Install unzip if not present
            sudo apt-get update && sudo apt-get install -y unzip

            # Unzip project (overwrite existing)
            unzip -o ~/project.zip -d ~/

            # Check for SSL certificates
            if [ ! -f "data/certbot/conf/live/mvt.redclief.com/fullchain.pem" ]; then
              echo "WARNING: SSL certificates not found at data/certbot/conf/live/mvt.redclief.com/fullchain.pem"
              echo "If this is a first-time setup, please run 'bash scripts/init-letsencrypt.sh' manually on the VM."
            fi

            # Rebuild and restart containers with a forced project name
            sudo VITE_API_URL=$VITE_API_URL docker compose -p meal-voucher -f ~/docker-compose.prod.yml up -d --build --force-recreate

            # Wait for containers to be ready
            echo "Waiting for containers to start..."
            sleep 15

            # Verify backend is accessible
            echo "Verifying backend health..."
            MAX_RETRIES=30
            RETRY_COUNT=0
            BACKEND_HEALTHY=false
            FRONTEND_HEALTHY=false

            # Install curl on host if not available
            if ! command -v curl &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y curl
            fi

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # Test backend health via direct port
              if curl -f -s http://localhost:8000/api/health > /dev/null 2>&1; then
                BACKEND_HEALTHY=true
                echo "Backend health check passed!"
              fi
              
              # Test frontend accessibility (Nginx)
              if curl -f -s http://localhost > /dev/null 2>&1; then
                FRONTEND_HEALTHY=true
                echo "Frontend (Nginx) is reachable on port 80!"
              fi

              if [ "$BACKEND_HEALTHY" = true ] && [ "$FRONTEND_HEALTHY" = true ]; then
                break
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES: Backend=$BACKEND_HEALTHY, Frontend=$FRONTEND_HEALTHY. Retrying..."
              sleep 2
            done

            # Check container status
            echo "Container status:"
            sudo docker compose -p meal-voucher -f ~/docker-compose.prod.yml ps

            if [ "$FRONTEND_HEALTHY" = false ]; then
              echo "ERROR: Frontend is not reachable. This is likely due to missing SSL certificates or Nginx configuration error."
              echo "Frontend logs:"
              sudo docker compose -p meal-voucher -f ~/docker-compose.prod.yml logs frontend --tail=100
            fi

            # Check backend logs if health check failed
            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "ERROR: Backend health check failed after $MAX_RETRIES attempts"
              echo "Backend logs:"
              sudo docker compose -p meal-voucher -f ~/docker-compose.prod.yml logs backend --tail=100
              exit 1
            fi

            if [ "$FRONTEND_HEALTHY" = false ]; then
               exit 1
            fi

            # Clean up unused images
            sudo docker image prune -f
